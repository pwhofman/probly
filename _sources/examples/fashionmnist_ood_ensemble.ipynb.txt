{
 "cells": [
  {
   "metadata": {},
   "cell_type": "markdown",
   "source": "# Out-of-Distribution Detection with an Ensemble",
   "id": "f14bce88ab285874"
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "initial_id",
   "metadata": {
    "ExecuteTime": {
     "end_time": "2025-04-03T11:13:54.646942Z",
     "start_time": "2025-04-03T11:13:54.643713Z"
    },
    "collapsed": true
   },
   "outputs": [],
   "source": [
    "import matplotlib.pyplot as plt\n",
    "import torch\n",
    "from torch import nn, optim\n",
    "from torch.utils.data import DataLoader\n",
    "import torchvision\n",
    "import torchvision.transforms as T\n",
    "from tqdm import tqdm\n",
    "\n",
    "from probly.quantification.classification import mutual_information\n",
    "from probly.representation import Ensemble\n",
    "from probly.tasks import out_of_distribution_detection"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ad45423e645d25d2",
   "metadata": {},
   "source": "### Load data and create neural network"
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "36f140ff85be3464",
   "metadata": {
    "ExecuteTime": {
     "end_time": "2025-04-03T11:13:54.680501Z",
     "start_time": "2025-04-03T11:13:54.653813Z"
    }
   },
   "outputs": [],
   "source": [
    "transforms = T.Compose([T.ToTensor(), torch.flatten])\n",
    "\n",
    "train = torchvision.datasets.FashionMNIST(root=\"~/datasets/\", train=True, download=True, transform=transforms)\n",
    "test = torchvision.datasets.FashionMNIST(root=\"~/datasets/\", train=False, download=True, transform=transforms)\n",
    "train_loader = DataLoader(train, batch_size=256, shuffle=True)\n",
    "test_loader = DataLoader(test, batch_size=256, shuffle=False)\n",
    "\n",
    "ood = torchvision.datasets.MNIST(root=\"~/datasets/\", train=False, download=True, transform=transforms)\n",
    "ood_loader = DataLoader(ood, batch_size=256, shuffle=False)\n",
    "\n",
    "\n",
    "class Net(nn.Module):\n",
    "    \"\"\"Simple Neural Network class.\n",
    "\n",
    "    Attributes:\n",
    "        fc1: nn.Module, first fully connected layer\n",
    "        fc2: nn.Module, second fully connected layer\n",
    "        fc3: nn.Module, third fully connected layer\n",
    "        act: nn.Module, activation function\n",
    "    \"\"\"\n",
    "\n",
    "    def __init__(self) -> None:\n",
    "        \"\"\"Initializes an instance of the Net class.\"\"\"\n",
    "        super().__init__()\n",
    "        self.fc1 = nn.Linear(784, 100)\n",
    "        self.fc2 = nn.Linear(100, 100)\n",
    "        self.fc3 = nn.Linear(100, 10)\n",
    "        self.act = nn.ReLU()\n",
    "\n",
    "    def forward(self, x: torch.Tensor) -> torch.Tensor:\n",
    "        \"\"\"Forward pass of the neural network.\n",
    "\n",
    "        Args:\n",
    "            x: torch.Tensor, input data\n",
    "        Returns:\n",
    "            torch.Tensor, output data\n",
    "        \"\"\"\n",
    "        x = self.act(self.fc1(x))\n",
    "        x = self.act(self.fc2(x))\n",
    "        x = self.fc3(x)\n",
    "        return x"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "2bdf6ad4b8416b15",
   "metadata": {},
   "source": "### Make neural network a dropout model"
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "e846c75162008235",
   "metadata": {
    "ExecuteTime": {
     "end_time": "2025-04-03T11:13:54.695484Z",
     "start_time": "2025-04-03T11:13:54.690295Z"
    }
   },
   "outputs": [],
   "source": [
    "ensemble = Ensemble(Net(), 5)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "13393ea634149065",
   "metadata": {},
   "source": "### Train each ensemble member as usual"
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "4159c8c1b155349c",
   "metadata": {
    "ExecuteTime": {
     "end_time": "2025-04-03T11:15:34.726266Z",
     "start_time": "2025-04-03T11:13:54.706072Z"
    }
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "100%|██████████| 5/5 [01:39<00:00, 19.93s/it]\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Accuracy: 0.8809\n"
     ]
    }
   ],
   "source": [
    "criterion = nn.CrossEntropyLoss()\n",
    "for model in tqdm(ensemble.models):\n",
    "    optimizer = optim.Adam(model.parameters())\n",
    "    for _ in range(10):\n",
    "        model.train()\n",
    "        for inputs, targets in train_loader:\n",
    "            optimizer.zero_grad()\n",
    "            outputs = model(inputs)\n",
    "            loss = criterion(outputs, targets)\n",
    "            loss.backward()\n",
    "            optimizer.step()\n",
    "\n",
    "# compute accuracy on test set\n",
    "correct = 0\n",
    "total = 0\n",
    "ensemble.eval()\n",
    "for inputs, targets in test_loader:\n",
    "    outputs = ensemble.predict_pointwise(inputs)\n",
    "    correct += (outputs.argmax(1) == targets).sum().item()\n",
    "    total += targets.size(0)\n",
    "print(f\"Accuracy: {correct / total}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "9f498d9c316bedc5",
   "metadata": {},
   "source": "### Compute epistemic uncertainty for in-distribution (FashionMNIST) and out-of-distribution (MNIST) data"
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "2cb4100584576a06",
   "metadata": {
    "ExecuteTime": {
     "end_time": "2025-04-03T11:15:35.456050Z",
     "start_time": "2025-04-03T11:15:34.747147Z"
    }
   },
   "outputs": [],
   "source": [
    "@torch.no_grad()\n",
    "def torch_get_outputs(model: nn.Module, loader: DataLoader) -> torch.Tensor:\n",
    "    \"\"\"Generate outputs of the model given data from a loader.\n",
    "\n",
    "    Args:\n",
    "        model: nn.Module, model\n",
    "        loader: DataLoader, data loader\n",
    "    \"\"\"\n",
    "    outputs = torch.empty(0)\n",
    "    for data, _ in loader:\n",
    "        outputs = torch.cat((outputs, model.predict_representation(data)), dim=0)\n",
    "    return outputs\n",
    "\n",
    "\n",
    "# get all outputs\n",
    "outputs_id = torch_get_outputs(ensemble, test_loader)\n",
    "outputs_ood = torch_get_outputs(ensemble, ood_loader)\n",
    "outputs_id = outputs_id.numpy()\n",
    "outputs_ood = outputs_ood.numpy()\n",
    "\n",
    "# compute uncertainties\n",
    "uncertainty_id = mutual_information(outputs_id)\n",
    "uncertainty_ood = mutual_information(outputs_ood)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "8ca2d34292477c67",
   "metadata": {},
   "source": "### Do Out-of-Distribution task"
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "7dcf980787a9f204",
   "metadata": {
    "ExecuteTime": {
     "end_time": "2025-04-03T11:15:35.547494Z",
     "start_time": "2025-04-03T11:15:35.460598Z"
    }
   },
   "outputs": [
    {
     "data": {
      "image/png": "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ifXhY6mVFw0vpUuXvmW7XBlgbrvtNsmTJ4+cOnUq0fP6ODw8PNn3BAcHm5unYsWKZdk+6i+Mr/3S5CSOp3dxPL2L4+ldHE/vCfHRY3mryosjUHKhfPnySZ06dWTDhg2JKir6uGHDhjm6bwAAIOflygqM0u6g7t27S926dc3aLzqN+tKlS/Lss8/m9K4BAIAclmsDTMeOHeXMmTMycuRIs5BdrVq1ZO3atTcN7M1u2k316quv3tRdhYzheHoXx9O7OJ7exfH0nmCOZe5dBwYAAMCqMTAAAAC3QoABAADWIcAAAADrEGAAAIB1CDDJmD59utx1112SP39+c1HJr7766pbtly5dKpUrVzbtq1evLqtXr862ffW14/nee+9JkyZNpHjx4uam179K7fj7m/T+fjoWL15sVqVu27Ztlu+jLx/Pc+fOSd++faVUqVJmBkjFihX5/3wGj6Uuj1GpUiUpUKCAWVU2IiJCrl69mm37m5t9/vnn8sQTT5jVaPX/t5988kmq79m8ebPUrl3b/F5WqFBB5s+fLz5NZyHhfxYvXuzKly+f6x//+Idr3759rueff95VrFgx16lTp5Jtv3XrVleePHlcEyZMcO3fv981fPhwV968eV179uzJ9n33hePZuXNn1/Tp013ffPON68CBA65nnnnGVbRoUdexY8eyfd994Xg6Dh8+7LrjjjtcTZo0cT311FPZtr++djyvXbvmqlu3rqt169auL774whzXzZs3u3bv3u3yd+k9lgsXLnQFBwebez2O69atc5UqVcoVERGR7fueG61evdo1bNgw17Jly3SmsGv58uW3bP/TTz+5ChYs6IqMjDTnonfeececm9auXevyVQSYJO6//35X37593Y8TEhJcpUuXdo0bNy7Z9k8//bSrTZs2iZ6rX7++64UXXsjyffXF45lUfHy8q0iRIq4FCxZk4V769vHUY/jAAw+45syZ4+revTsBJhPHc+bMma67777bFRcXl4176ZvHUts2a9Ys0XN68m3UqFGW76tt0hJgBg0a5LrvvvsSPdexY0dXq1atXL6KLiQPcXFxsmvXLtNt4QgMDDSPo6Ojk32PPu/ZXrVq1SrF9v4kI8czqcuXL8v169clNDRU/F1Gj+fo0aMlLCxMevTokU176rvH89///re5nIl2IemimtWqVZM33nhDEhISxJ9l5Fg+8MAD5j1ON9NPP/1kuuJat26dbfvtS6L98FyUa1fizQm//vqr+UOUdLVffXzw4MFk36OrBCfXXp/3dxk5nkkNHjzY9AEn/T+mP8rI8fziiy9k7ty5snv37mzaS98+nnqS3bhxo3Tp0sWcbH/44Qfp06ePCdm6Kqq/ysix7Ny5s3lf48aNzdWH4+PjpXfv3vK3v/0tm/bat5xM4VykV62+cuWKGWfka6jAINcaP368GXi6fPlyMygQ6aOXo+/atasZGK1XeEfm6UVltZo1e/Zsc8FZveTJsGHDZNasWTm9a9bRAadavZoxY4Z8/fXXsmzZMlm1apWMGTMmp3cNlqAC40H/yOfJk0dOnTqV6Hl9HB4enux79Pn0tPcnGTmejkmTJpkA89lnn0mNGjWyeE9983j++OOP8vPPP5uZDJ4nYBUUFCQxMTFyzz33iL/KyO+nzjzKmzeveZ+jSpUq5l+/2o2SL18+8UcZOZYjRowwAbtnz57msc7g1Av29urVy4RC7YJC2oWncC4KCQnxyeqL4jfEg/7x0X9VbdiwIdEffH2s/d7J0ec926uoqKgU2/uTjBxPNWHCBPOvML14p16NHBk7njq1f8+ePab7yLk9+eST0rRpU/OzTlv1Zxn5/WzUqJHpNnKCoDp06JAJNv4aXjJ6LHV8W9KQ4gRDLtGXfg398VyU06OIc+NUQJ3aN3/+fDMVrVevXmYq4MmTJ83rXbt2dQ0ZMiTRNOqgoCDXpEmTzLTfV199lWnUmTie48ePN1MxP/74Y9eJEyfctwsXLuTgt7D3eCbFLKTMHc8jR46YWXH9+vVzxcTEuFauXOkKCwtzjR071uXv0nss9W+lHssPP/zQTAFev36965577jEzO+Eyf/N0OQm96an6zTffND//8ssv5vUhQ4aYY5p0GvXAgQPNuUiXo2AatR/S+fPlypUzJ1KdGrh9+3b3aw899JA5CXhasmSJq2LFiqa9TmNbtWpVDuy1bxzPO++80/yfNelN/9ghY7+fnggwmT+e27ZtM0sl6Mlap1S//vrrZqo60ncsr1+/7nrttddMaMmfP7+rbNmyrj59+rjOnj2bQ3ufu2zatCnZv4XOMezevbs5pknfU6tWLXP89Xdz3rx5Ll8WoP+T01UgAACA9GAMDAAAsA4BBgAAWIcAAwAArEOAAQAA1iHAAAAA6xBgAACAdQgwAADAOgQYAABgHQIMAACwDgEGAABYhwADAACsQ4ABAABim/8DHHFpBrztKF4AAAAASUVORK5CYII=",
      "text/plain": [
       "<Figure size 640x480 with 1 Axes>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "AUROC with FashionMNIST as iD and MNIST as OoD: 0.910\n"
     ]
    }
   ],
   "source": [
    "# plot the uncertainties in a histogram\n",
    "plt.hist(uncertainty_id, bins=50, alpha=0.5, label=\"In-Distribution\")\n",
    "plt.hist(uncertainty_ood, bins=50, alpha=0.5, label=\"Out-of-Distribution\")\n",
    "plt.legend()\n",
    "plt.show()\n",
    "\n",
    "auroc = out_of_distribution_detection(uncertainty_id, uncertainty_ood)\n",
    "print(f\"AUROC with FashionMNIST as iD and MNIST as OoD: {auroc:.3f}\")"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 2
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython2",
   "version": "2.7.6"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
