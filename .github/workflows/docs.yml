name: CI Documentation Check

# Trigger the workflow on pull requests targeting the main development branch
on:
  pull_request:
    branches:
      - main
      - master

jobs:
  docs_check:
    name: "Sphinx Clean Build Validation (Python ${{ matrix.python-version }})"
    runs-on: ubuntu-latest

    # Defines a matrix to test across multiple Python versions
    strategy:
      matrix:
        python-version: ["3.9", "3.11"]

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      - name: 2. Set up Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: 3. Install Core and CI Dependencies
        # Installs the project itself, plus necessary tools for linting, typing, and testing.
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r docs/requirements.txt
          pip install ruff mypy pytest pytest-cov sphinxcontrib-spelling

      # --- CODE INTEGRITY CHECKS ---
      - name: 4. Run Ruff Style and Linting Checks
        run: |
          ruff check .
          ruff format --check .

      - name: 5. Run MyPy Static Type Check
        run: |
          mypy src/

      - name: 6. Execute Unit Tests and Measure Coverage
        # Runs tests and generates a coverage report for the source code.
        run: |
          pytest --cov=src/probly --cov-report=xml

      # --- DOCUMENTATION QUALITY CHECKS (Using -W to enforce zero warnings) ---
      - name: 7. Execute Main Zero-Warning Build Check
        # Core check: The -W flag treats ALL warnings as errors.
        run: |
          sphinx-build -b html -W docs/source _build/html

      - name: 8. Execute Docstring and Example Tests
        # Verifies code functionality in documentation snippets.
        run: |
          sphinx-build -b doctest -W docs/source _build/doctest

      - name: 9. Execute External Link Check
        run: |
          sphinx-build -b linkcheck -W docs/source _build/linkcheck

      - name: 10. Execute Spelling Check
        run: |
          sphinx-build -b spelling -W docs/source _build/spelling

      # --- ARTIFACT MANAGEMENT ---
      - name: 11. Upload Documentation Artifacts
        # Uploads the built HTML files for inspection, even if previous steps failed (for debugging).
        uses: actions/upload-artifact@v4
        with:
          name: html-docs-python-${{ matrix.python-version }}
          path: _build/html
          if: always()
