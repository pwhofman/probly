<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" />

    <!-- Generated with Sphinx 8.2.3 and Furo 2024.08.06 -->
        <title>A Brief Introduction to Ensemble Transformation - probly 0.3.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=201d0c9a" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">probly 0.3.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><div class="sidebar-scroll"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../_static/logo/logo_light.png" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../_static/logo/logo_dark.png" alt="Dark Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Content</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">The <code class="docutils literal notranslate"><span class="pre">probly</span></code> Python Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core_concepts.html">Core Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../main_components.html">Main Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_topics.html">Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples_and_tutorials.html">Examples and Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods.html">Implemented methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing to probly üèîÔ∏è</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References and Further Reading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ and Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Notebooks</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../notebooks/examples/index.html">Notebook Examples</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Notebook Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../notebooks/examples/utilities_and_layers/index.html">Utilities and Layers</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Utilities and Layers</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../notebooks/examples/utilities_and_layers/custom_loss_functions.html">Custom Loss Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../notebooks/examples/utilities_and_layers/metrics.html">Evaluation Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../notebooks/examples/utilities_and_layers/probabilistic_layers.html">Key Probabilistic Layers in <code class="docutils literal notranslate"><span class="pre">probly</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../notebooks/examples/utilities_and_layers/utility_functions.html">Utility Functions</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../notebooks/examples/evaluation_and_quantification/index.html">Evaluation and Quantification</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Evaluation and Quantification</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../notebooks/examples/evaluation_and_quantification/calibration_metrics.html">Calibration Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../notebooks/examples/evaluation_and_quantification/interpretation_techniques.html">Interpretation techniques</a></li>
<li class="toctree-l3"><a class="reference internal" href="../notebooks/examples/evaluation_and_quantification/visualization_tools.html">Visualisation Tools</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/examples/bayesian_transformation.html">Bayesian Transformation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/examples/dropconnect_transformation.html">Dropconnect Transformation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/examples/dropout_transformation.html">Dropout Transformation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/examples/ensemble_transformation.html">Ensemble Transformation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/examples/evidential_classification_transformation.html">Evidential Classification Transformation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/examples/evidential_regression_transformation.html">Evidential Regression Transformation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/examples/fashionmnist_ood_ensemble.html">Out-of-Distribution Detection with an Ensemble</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/examples/label_relaxation_calibration.html">Calibration with Label Relaxation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/examples/lazy_dispatch_test.html">Lazy Dispatch Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/examples/multilib_demo.html">Multilib Demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/examples/pytraverse_tutorial.html">A Brief Introduction to PyTraverse</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/examples/sklearn_selective_prediction.html">Using probly with scikit-learn</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/examples/temperature_scaling_calibration.html">Calibration using Temperature Scaling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/examples/train_bnn_classification.html">Bayesian Neural Networks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/examples/train_evidential_classification.html">Evidential Model for Classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/examples/train_evidential_regression.html">Evidential Regression Model</a></li>
</ul>
</li>
</ul>

</div>
</div><div style="text-align: center; margin-top: 1rem; margin-bottom: 1rem;">
  <a href="https://github.com/pwhofman/probly" target="_blank" rel="noopener noreferrer" title="GitHub Repository">
    <img src="../_static/github-mark.svg" alt="GitHub Logo" width="28" height="28" style="display: inline-block;">
  </a>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          

<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="a-brief-introduction-to-ensemble-transformation">
<h1>A Brief Introduction to Ensemble Transformation<a class="headerlink" href="#a-brief-introduction-to-ensemble-transformation" title="Link to this heading">¬∂</a></h1>
<p>The goal of this notebook is to showcase the <code class="docutils literal notranslate"><span class="pre">ensemble</span></code> function, which is based on the provided code files (<code class="docutils literal notranslate"><span class="pre">common.py</span></code>, <code class="docutils literal notranslate"><span class="pre">torch.py</span></code>, <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>). We will demonstrate how to use it to create an ensemble of models from a base PyTorch model.</p>
<section id="but-what-is-an-ensemble">
<h2>But what is an Ensemble?<a class="headerlink" href="#but-what-is-an-ensemble" title="Link to this heading">¬∂</a></h2>
<p>An <em>Ensemble</em> in machine learning is usually a method that uses a finite set of learning algorithms. Instead of relying on a single model, an ensemble combines the results of several models to create a better result.
Those different models usually slightly differ in their parameters.
This often improves robustness and helps quantify <strong>uncertainty</strong> ‚Äî for example, when the ensemble members disagree, we know the model is unsure.<br />
In <code class="docutils literal notranslate"><span class="pre">probly</span></code>, the <code class="docutils literal notranslate"><span class="pre">ensemble</span></code> transformation automates the creation of such model collections directly from a base PyTorch model. <br>
<strong>Why use Ensemble?</strong> <br>
Because it saves you from having to manually copy, reset, and manage multiple model instances yourself. <code class="docutils literal notranslate"><span class="pre">ensemble</span></code> does all of that for you automatically</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">lazy_dispatch</span><span class="w"> </span><span class="kn">import</span> <span class="n">lazydispatch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lazy_dispatch.isinstance</span><span class="w"> </span><span class="kn">import</span> <span class="n">LazyType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">probly.transformation.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">ensemble</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pytraverse</span><span class="w"> </span><span class="kn">import</span> <span class="n">singledispatch_traverser</span><span class="p">,</span> <span class="n">traverse</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">lazy_dispatch.isinstance</span><span class="w"> </span><span class="kn">import</span> <span class="n">LazyType</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">probly.predictor</span><span class="w"> </span><span class="kn">import</span> <span class="n">Predictor</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>  <span class="c1"># noqa: F404</span>


<span class="c1"># Our base model</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SimpleNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the network architecture with two linear layers.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>  <span class="c1"># noqa: ANN201, ANN001</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run a forward pass of the network.&quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the parameters of all layers.&quot;&quot;&quot;</span>
        <span class="c1"># Important for Deep Ensembles: a custom reset function</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Custom reset_parameters of SimpleNet called!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer1</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer2</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>


<span class="n">base_model</span> <span class="o">=</span> <span class="n">SimpleNet</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base model weight (layer1): </span><span class="si">{</span><span class="n">base_model</span><span class="o">.</span><span class="n">layer1</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Creating ensemble with reset (default) ---&quot;</span><span class="p">)</span>
<span class="n">base_model_2</span> <span class="o">=</span> <span class="n">SimpleNet</span><span class="p">()</span>
<span class="n">base_weight</span> <span class="o">=</span> <span class="n">base_model_2</span><span class="o">.</span><span class="n">layer1</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base model weight: </span><span class="si">{</span><span class="n">base_weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># ensemble is the function from common.py</span>
<span class="c1"># reset_params=True is the default</span>
<span class="n">model_ensemble</span> <span class="o">=</span> <span class="n">ensemble</span><span class="p">(</span><span class="n">base_model_2</span><span class="p">,</span> <span class="n">num_members</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">reset_params</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Ensemble created: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">model_ensemble</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of members: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">model_ensemble</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Let&#39;s compare the weights to see if they are different</span>
<span class="n">weight0</span> <span class="o">=</span> <span class="n">model_ensemble</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layer1</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="n">weight1</span> <span class="o">=</span> <span class="n">model_ensemble</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">layer1</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="n">weight2</span> <span class="o">=</span> <span class="n">model_ensemble</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">layer1</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weight of member 0: </span><span class="si">{</span><span class="n">weight0</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weight of member 1: </span><span class="si">{</span><span class="n">weight1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weight of member 2: </span><span class="si">{</span><span class="n">weight2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">base_weight</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">weight0</span><span class="p">,</span> <span class="n">weight1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">weight0</span> <span class="o">!=</span> <span class="n">weight1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All weights are different (as expected).&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Base model weight (layer1): 0.053378403186798096
--- Creating ensemble with reset (default) ---
Base model weight: 0.18488982319831848
Custom reset_parameters of SimpleNet called!
Custom reset_parameters of SimpleNet called!
Custom reset_parameters of SimpleNet called!

Ensemble created: &lt;class &#39;torch.nn.modules.container.ModuleList&#39;&gt;
Number of members: 3
Weight of member 0: -0.11245134472846985
Weight of member 1: -0.2733441889286041
Weight of member 2: 0.1302759349346161
All weights are different (as expected).
</pre></div>
</div>
</div>
</div>
</section>
<section id="setup-dependencies-and-code-definitions">
<h2>1. Setup: Dependencies and Code Definitions<a class="headerlink" href="#setup-dependencies-and-code-definitions" title="Link to this heading">¬∂</a></h2>
<p>Before we can use the <code class="docutils literal notranslate"><span class="pre">ensemble</span></code> function, we‚Äôll define it and its components as described in the code files (<code class="docutils literal notranslate"><span class="pre">common.py</span></code>, <code class="docutils literal notranslate"><span class="pre">torch.py</span></code>, <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>). This ensures this notebook is self-contained.</p>
<p>We will copy the contents of the provided files here and adjust the relative imports.
We use three components: <code class="docutils literal notranslate"><span class="pre">common.py</span></code> for dispatching and <code class="docutils literal notranslate"><span class="pre">torch.py</span></code> for generating an ensemble. <code class="docutils literal notranslate"><span class="pre">init.py</span></code>connects the generic ensemnle logic with the PyTorch implementation. All components will be explained further below.</p>
<p>To prevent errors, run the cells in the given order.</p>
<section id="how-init-py-connects-ensemble-components">
<h3>1.1 How <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> connects Ensemble Components<a class="headerlink" href="#how-init-py-connects-ensemble-components" title="Link to this heading">¬∂</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file defines the public interface of the ensemble module.
It re-exports the main functions <code class="docutils literal notranslate"><span class="pre">ensemble</span></code> and <code class="docutils literal notranslate"><span class="pre">register</span></code> so they can be imported directly from <code class="docutils literal notranslate"><span class="pre">probly.ensemble</span></code>.
Additionally, it performs a <em>lazy registration</em> of the PyTorch backend, which means the Torch implementation is only loaded when a Torch model is actually used.
This design avoids unnecessary imports, prevents circular dependencies, and keeps the package lightweight and modular.</p>
<p><em>NOTE:</em> Since we are in a notebook, we are performing the registration
(which already happened in the ‚Äòtorch.py‚Äô cell) explicitly.
The ‚Äòdelayed_register‚Äô logic is not needed here because we loaded ‚Äòtorch.py‚Äô
directly.</p>
</section>
<section id="how-common-py-implements-the-main-logic">
<h3>1.2 How <code class="docutils literal notranslate"><span class="pre">common.py</span></code> implements the Main Logic<a class="headerlink" href="#how-common-py-implements-the-main-logic" title="Link to this heading">¬∂</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">common.py</span></code> file defines the core logic of the ensemble module.
It introduces a generic dispatcher called <code class="docutils literal notranslate"><span class="pre">ensemble_generator</span></code>, which dynamically selects the correct ensemble creation function based on the model type.
The register function allows developers to link new model types (such as PyTorch or custom predictors) to their specific generator implementations.
Finally, the <code class="docutils literal notranslate"><span class="pre">ensemble()</span></code> function provides a simple, user-facing API that hides the dispatch mechanism and automatically calls the right generator.
Together, these components make the ensemble system flexible and easily extensible to other frameworks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>  <span class="c1"># noqa: E402, F404, RUF100</span>

<span class="sd">&quot;&quot;&quot;Shared ensemble implementation.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span>  <span class="c1"># noqa: E402</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">lazy_dispatch.isinstance</span><span class="w"> </span><span class="kn">import</span> <span class="n">LazyType</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">probly.predictor</span><span class="w"> </span><span class="kn">import</span> <span class="n">Predictor</span>


<span class="nd">@lazydispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ensemble_generator</span><span class="p">[</span><span class="n">In</span><span class="p">,</span> <span class="n">KwIn</span><span class="p">,</span> <span class="n">Out</span><span class="p">](</span><span class="n">base</span><span class="p">:</span> <span class="n">Predictor</span><span class="p">[</span><span class="n">In</span><span class="p">,</span> <span class="n">KwIn</span><span class="p">,</span> <span class="n">Out</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Predictor</span><span class="p">[</span><span class="n">In</span><span class="p">,</span> <span class="n">KwIn</span><span class="p">,</span> <span class="n">Out</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate an ensemble from a base model.&quot;&quot;&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;No ensemble generator is registered for type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">base</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">LazyType</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register a class which can be used as a base for an ensemble.&quot;&quot;&quot;</span>
    <span class="n">ensemble_generator</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">generator</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ensemble</span><span class="p">[</span><span class="n">T</span><span class="p">:</span> <span class="n">Predictor</span><span class="p">](</span><span class="n">base</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">n_members</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">reset_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create an ensemble predictor from a base predictor.</span>

<span class="sd">    Args:</span>
<span class="sd">        base: Predictor, The base model to be used for the ensemble.</span>
<span class="sd">        n_members: The number of members in the ensemble.</span>
<span class="sd">        reset_params: Whether to reset the parameters of each member.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Predictor, The ensemble predictor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ensemble_generator</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">n_members</span><span class="o">=</span><span class="n">n_members</span><span class="p">,</span> <span class="n">reset_params</span><span class="o">=</span><span class="n">reset_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-torch-implementation-torch-py">
<h3>1.3 The Torch Implementation: <code class="docutils literal notranslate"><span class="pre">torch.py</span></code><a class="headerlink" href="#the-torch-implementation-torch-py" title="Link to this heading">¬∂</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">torch.py</span></code> file implements the ensemble generator specifically for PyTorch models.
It uses the <code class="docutils literal notranslate"><span class="pre">pytraverse</span></code> library to recursively clone neural networks and optionally reset their parameters using each layer‚Äôs <code class="docutils literal notranslate"><span class="pre">reset_parameters()</span></code> method.
The main function, <code class="docutils literal notranslate"><span class="pre">generate_torch_ensemble()</span></code>, creates multiple independent copies of a given base model and returns them as an nn.ModuleList.
This ensures that each ensemble member has its own parameters, allowing the ensemble to represent independent model instances.
At the end, the PyTorch generator is registered with the dispatcher using register(<code class="docutils literal notranslate"><span class="pre">nn.Module</span></code>, <code class="docutils literal notranslate"><span class="pre">generate_torch_ensemble</span></code>), linking it seamlessly to the common interface.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Required third-party dependencies</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>  <span class="c1"># noqa: TC003</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">lazy_dispatch</span><span class="w"> </span><span class="kn">import</span> <span class="n">lazydispatch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lazy_dispatch.isinstance</span><span class="w"> </span><span class="kn">import</span> <span class="n">LazyType</span>  <span class="c1"># noqa: TC001</span>


<span class="c1"># --- Mocks for &#39;probly&#39; dependencies that were not provided ---</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Predictor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mock class for probly.predictor.Predictor.&quot;&quot;&quot;</span>


<span class="n">TORCH_MODULE</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span>  <span class="c1"># Mock for probly.lazy_types.TORCH_MODULE</span>

<span class="c1"># Mock for probly.traverse_nn.nn_traverser</span>
<span class="n">nn_traverser</span> <span class="o">=</span> <span class="n">singledispatch_traverser</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">](</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;nn_traverser&quot;</span><span class="p">)</span>


<span class="nd">@nn_traverser</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_nn_traverse_default</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">traverse</span><span class="p">:</span> <span class="n">traverse</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>  <span class="c1"># type: ignore  # noqa: PGH003</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Default traverser that maps children.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">traverse</span><span class="o">.</span><span class="n">map_children</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>  <span class="c1"># noqa: F404</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>

<span class="n">reset_traverser</span> <span class="o">=</span> <span class="n">singledispatch_traverser</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">](</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;reset_traverser&quot;</span><span class="p">)</span>


<span class="nd">@reset_traverser</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;reset_parameters&quot;</span><span class="p">):</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>  <span class="c1"># type: ignore[operator]</span>
    <span class="k">return</span> <span class="n">obj</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_copy</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
    <span class="c1"># simple deep copy without relying on the nn_traverser mock</span>
    <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_reset_copy</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
    <span class="n">cloned</span> <span class="o">=</span> <span class="n">_copy</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cloned</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;reset_parameters&quot;</span><span class="p">):</span>
            <span class="n">m</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cloned</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generate_torch_ensemble</span><span class="p">(</span>
    <span class="n">obj</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
    <span class="n">n_members</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">reset_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a torch ensemble by copying the base model n_members times, resetting the parameters of each member.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">reset_params</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">_reset_copy</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_members</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">_copy</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_members</span><span class="p">)])</span>


<span class="n">register</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">generate_torch_ensemble</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="the-problem-manual-ensemble-creation">
<h2>2. The Problem: Manual Ensemble Creation<a class="headerlink" href="#the-problem-manual-ensemble-creation" title="Link to this heading">¬∂</a></h2>
<p>Let‚Äôs say we have a base model in PyTorch and want to create a ‚ÄúDeep Ensemble‚Äù for uncertainty quantification. For this, we need several copies of this model, each of which must have different initialized weights.</p>
<p>The naive approach would be to manually copy the model and reset the parameters. This can be tedious, especially with complex, nested models.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Our base model</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SimpleNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the network architecture with two linear layers.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>  <span class="c1"># noqa: ANN201, ANN001</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run a forward pass of the network.&quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the parameters of all layers.&quot;&quot;&quot;</span>
        <span class="c1"># Important for Deep Ensembles: a custom reset function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer1</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer2</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>


<span class="n">base_model</span> <span class="o">=</span> <span class="n">SimpleNet</span><span class="p">()</span>


<span class="c1"># Manual approach</span>
<span class="n">n_members</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">manual_ensemble</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_members</span><span class="p">):</span>
    <span class="n">model_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">base_model</span><span class="p">)</span>
    <span class="c1"># We have to remember to reset the parameters manually</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model_copy</span><span class="p">,</span> <span class="s2">&quot;reset_parameters&quot;</span><span class="p">):</span>
        <span class="n">model_copy</span><span class="o">.</span><span class="n">reset_parameters</span><span class="p">()</span>
    <span class="n">manual_ensemble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_copy</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This works, but it‚Äôs cumbersome. We have to use <code class="docutils literal notranslate"><span class="pre">copy.deepcopy</span></code> and manually check for a <code class="docutils literal notranslate"><span class="pre">reset_parameters</span></code> method.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">torch.py</span></code> code automates this. The <code class="docutils literal notranslate"><span class="pre">_reset_copy</span></code> function uses <code class="docutils literal notranslate"><span class="pre">pytraverse</span></code> to recursively traverse the module and call <code class="docutils literal notranslate"><span class="pre">reset_parameters()</span></code> on every submodule that has it. This is a perfect example of the separation of concerns shown in <code class="docutils literal notranslate"><span class="pre">pytraverse_tutorial.ipynb</span></code> (cell <code class="docutils literal notranslate"><span class="pre">5ae1e551</span></code>): the traversal logic is separate from the reset logic.
In the next section, we will see how the <code class="docutils literal notranslate"><span class="pre">ensemble()</span></code> function automates this entire process, making ensemble creation both cleaner and safer.</p>
</section>
<section id="the-automated-solution-the-ensemble-function">
<h2>3. The Automated Solution: The ensemble() Function<a class="headerlink" href="#the-automated-solution-the-ensemble-function" title="Link to this heading">¬∂</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ensemble</span></code> function from <code class="docutils literal notranslate"><span class="pre">common.py</span></code> is a <code class="docutils literal notranslate"><span class="pre">lazydispatch</span></code> wrapper. It automatically selects the correct generator based on the type of the base model.</p>
<p>Since we registered <code class="docutils literal notranslate"><span class="pre">generate_torch_ensemble</span></code> for <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> (in the <code class="docutils literal notranslate"><span class="pre">torch.py</span></code> cell above), we can apply the <code class="docutils literal notranslate"><span class="pre">ensemble</span></code> function directly to our <code class="docutils literal notranslate"><span class="pre">SimpleNet</span></code> object.</p>
</section>
<section id="optional-behavior-cloning-without-reset">
<h2>Optional Behavior: Cloning Without Reset<a class="headerlink" href="#optional-behavior-cloning-without-reset" title="Link to this heading">¬∂</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ensemble</span></code> function also accepts <code class="docutils literal notranslate"><span class="pre">reset_params=False</span></code>.</p>
<p>In this case, <code class="docutils literal notranslate"><span class="pre">generate_torch_ensemble</span></code> calls the <code class="docutils literal notranslate"><span class="pre">_copy</span></code> function instead of <code class="docutils literal notranslate"><span class="pre">_reset_copy</span></code>. <code class="docutils literal notranslate"><span class="pre">_copy</span></code> simply uses the <code class="docutils literal notranslate"><span class="pre">nn_traverser</span></code> to clone the module without calling <code class="docutils literal notranslate"><span class="pre">reset_parameters()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Creating ensemble without reset ---&quot;</span><span class="p">)</span>
<span class="n">base_model_3</span> <span class="o">=</span> <span class="n">SimpleNet</span><span class="p">()</span>
<span class="n">base_weight_3</span> <span class="o">=</span> <span class="n">base_model_3</span><span class="o">.</span><span class="n">layer1</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base model weight: </span><span class="si">{</span><span class="n">base_weight_3</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># This time we set reset_params to False</span>
<span class="n">copied_ensemble</span> <span class="o">=</span> <span class="n">ensemble</span><span class="p">(</span><span class="n">base_model_3</span><span class="p">,</span> <span class="n">n_members</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">reset_params</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">weight0</span> <span class="o">=</span> <span class="n">copied_ensemble</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layer1</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="n">weight1</span> <span class="o">=</span> <span class="n">copied_ensemble</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">layer1</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Weight of member 0: </span><span class="si">{</span><span class="n">weight0</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weight of member 1: </span><span class="si">{</span><span class="n">weight1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">weight0</span> <span class="o">==</span> <span class="n">base_weight_3</span>  <span class="c1"># noqa: S101</span>
<span class="k">assert</span> <span class="n">weight1</span> <span class="o">==</span> <span class="n">base_weight_3</span>  <span class="c1"># noqa: S101</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All weights are identical to the base model (as expected).&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Creating ensemble without reset ---
Base model weight: 0.016505658626556396

Weight of member 0: 0.016505658626556396
Weight of member 1: 0.016505658626556396
All weights are identical to the base model (as expected).
</pre></div>
</div>
</div>
</div>
</section>
<section id="summary-and-key-takeaway">
<h2>4. Summary and Key Takeaway<a class="headerlink" href="#summary-and-key-takeaway" title="Link to this heading">¬∂</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ensemble</span></code> function is a powerful dispatcher that abstracts away the complexity of creating model ensembles.</p>
<p>By registering type-specific generators (like <code class="docutils literal notranslate"><span class="pre">generate_torch_ensemble</span></code> for <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code>) with the <code class="docutils literal notranslate"><span class="pre">ensemble_generator</span></code>, it provides a clean, extensible API.</p>
<p>Internally, the PyTorch implementation uses <code class="docutils literal notranslate"><span class="pre">pytraverse</span></code> to efficiently traverse, copy, and optionally reset parameters of the module structure. This demonstrates how the abstract concepts from <code class="docutils literal notranslate"><span class="pre">pytraverse_tutorial.ipynb</span></code> (like <code class="docutils literal notranslate"><span class="pre">singledispatch_traverser</span></code> and <code class="docutils literal notranslate"><span class="pre">traverse</span></code> with <code class="docutils literal notranslate"><span class="pre">{CLONE:</span> <span class="pre">True}</span></code>) are used in a real-world application to write robust and maintainable code.</p>
</section>
<section id="further-reading-and-references">
<h2>5. Further Reading and References<a class="headerlink" href="#further-reading-and-references" title="Link to this heading">¬∂</a></h2>
<ul class="simple">
<li><p><strong>Probly documentation:</strong> <em><strong>for more information on how everything in probly works</strong></em> <br> (https://github.com/pwhofman/probly/tree/main/docs)</p></li>
<li><p><strong>PyTraverse intro notebook:</strong> <em><strong>offers a deep tutorial on how pytraverse automates traversing</strong></em><br> (https://github.com/pwhofman/probly/blob/main/notebooks/examples/pytraverse_tutorial.ipynb)</p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, probly team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">A Brief Introduction to Ensemble Transformation</a><ul>
<li><a class="reference internal" href="#but-what-is-an-ensemble">But what is an Ensemble?</a></li>
<li><a class="reference internal" href="#setup-dependencies-and-code-definitions">1. Setup: Dependencies and Code Definitions</a><ul>
<li><a class="reference internal" href="#how-init-py-connects-ensemble-components">1.1 How <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> connects Ensemble Components</a></li>
<li><a class="reference internal" href="#how-common-py-implements-the-main-logic">1.2 How <code class="docutils literal notranslate"><span class="pre">common.py</span></code> implements the Main Logic</a></li>
<li><a class="reference internal" href="#the-torch-implementation-torch-py">1.3 The Torch Implementation: <code class="docutils literal notranslate"><span class="pre">torch.py</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-problem-manual-ensemble-creation">2. The Problem: Manual Ensemble Creation</a></li>
<li><a class="reference internal" href="#the-automated-solution-the-ensemble-function">3. The Automated Solution: The ensemble() Function</a></li>
<li><a class="reference internal" href="#optional-behavior-cloning-without-reset">Optional Behavior: Cloning Without Reset</a></li>
<li><a class="reference internal" href="#summary-and-key-takeaway">4. Summary and Key Takeaway</a></li>
<li><a class="reference internal" href="#further-reading-and-references">5. Further Reading and References</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=4621528c"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=ccdb6887"></script>
    </body>
</html>